#!/usr/bin/env bash
{ bitbucket_url=$(git remote get-url --push origin); bitbucket_url="${bitbucket_url/git\@bitbucket\.org\:$GIT_REPO_VENDOR/https://bitbucket.org/$GIT_REPO_VENDOR}"; previous_tag=0 ; for current_tag in $(git tag --sort=-creatordate); do if [ "$previous_tag" != 0 ]; then     tag_date=$(git log -1 --pretty=format:'%ad' --date=short ${previous_tag});     printf "## ${previous_tag} (${tag_date})\n\n[View Release](${bitbucket_url}/commits/tag/${previous_tag})\n\n";     git log ${current_tag}...${previous_tag} --pretty=format:"*  %s" --reverse | grep -v Merge;     printf "\n\n"; fi; previous_tag=${current_tag}; done ; previous_tag=$(git tag --sort=-creatordate | tail -n 1); tag_date=$(git log -1 --pretty=format:'%ad' --date=short ${previous_tag}); printf "## ${previous_tag} (${tag_date}\n\n[View Release](${bitbucket_url}/commits/tag/${previous_tag})\n\n"; git log ${previous_tag} --pretty=format:"*  %s" --reverse | grep -v Merge; printf "\n\n"; } > CHANGELOG.md
if [ $(git status --porcelain | grep CHANGELOG.md | wc -l) -gt 0 ]; then  latest_tag=$(git tag --sort=creatordate | tail -n 1); git add CHANGELOG.md; git tag -d  $latest_tag ; git commit --amend --no-edit; git tag $latest_tag ; git push origin master --tags; echo 'The CHANGELOG.md has been updated and pushed to the remote and added to the latest tag.'; exit 1; fi
